# 7库配合使用详解

## 库间协作关系图

```
┌─────────────────────────────────────────────────────────────┐
│                        应用层                               │
│  ┌─────────────────────────────────────────────────────┐  │
│  │            CrawlerSystem (业务整合层)                 │  │
│  │  - 请求调度 - 指纹管理 - IP管理 - 连接管理           │  │
│  └─────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                            │
        ┌───────────────────┼───────────────────┐
        │                   │                   │
        ▼                   ▼                   ▼
┌──────────────┐   ┌──────────────┐   ┌──────────────┐
│  fingerprint │   │  domaindns   │   │ localippool  │
│  (指纹模拟)   │   │  (DNS解析)   │   │  (IP管理)    │
└──────────────┘   └──────────────┘   └──────────────┘
        │                   │                   │
        └───────────────────┼───────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────┐
        │         conn (连接抽象)            │
        │  - 统一连接接口 - 协议抽象         │
        └───────────────────────────────────┘
                            │
        ┌───────────────────┼───────────────────┐
        │                   │                   │
        ▼                   ▼                   ▼
┌──────────────┐   ┌──────────────┐   ┌──────────────┐
│ netconnpool  │   │     quic     │   │    logs      │
│ (TCP连接池)   │   │ (QUIC连接池) │   │  (日志记录)   │
└──────────────┘   └──────────────┘   └──────────────┘
```

## 详细协作流程

### 场景1：HTTP请求执行（TCP）

```
1. 应用层发起请求
   │
   ├─→ fingerprint.GetRandomFingerprint()
   │   └─→ 返回: FingerprintResult {
   │           Profile: TLS配置,
   │           UserAgent: "Mozilla/5.0...",
   │           Headers: HTTP请求头
   │       }
   │
   ├─→ domaindns.Resolve("example.com")
   │   └─→ 返回: "93.184.216.34"
   │
   ├─→ localippool.GetAvailableIP()
   │   └─→ 返回: "192.168.1.100"
   │
   └─→ netconnpool.GetConnection(options)
       │   options包含:
       │   - TargetIP: "93.184.216.34"
       │   - LocalIP: "192.168.1.100"
       │   - Fingerprint: TLS配置
       │   - Headers: HTTP请求头
       │
       ├─→ conn.NewConnection(options)
       │   ├─→ 使用 fingerprint.Profile 配置TLS
       │   ├─→ 使用 domaindns 解析的IP建立连接
       │   └─→ 使用 localippool 的IP作为本地IP
       │
       └─→ 返回: Connection对象
           │
           └─→ connection.SendRequest()
               └─→ logs.Info("发送请求")
                   └─→ 发送HTTP请求
                       └─→ logs.Info("请求成功")
```

### 场景2：HTTP请求执行（QUIC）

```
1. 应用层发起QUIC请求
   │
   ├─→ fingerprint.GetRandomFingerprint()
   │
   ├─→ domaindns.Resolve("example.com")
   │
   ├─→ localippool.GetAvailableIP()
   │
   └─→ quic.GetConnection(options)
       │
       ├─→ conn.NewQUICConnection(options)
       │   ├─→ 使用 fingerprint.Profile
       │   ├─→ 使用 domaindns 解析的IP
       │   └─→ 使用 localippool 的IP
       │
       └─→ 返回: QUIC Connection对象
           │
           └─→ connection.SendRequest()
               └─→ logs.Info("发送QUIC请求")
```

### 场景3：错误处理和恢复

```
请求失败
   │
   ├─→ logs.Error("请求失败", error)
   │
   ├─→ 判断错误类型
   │   │
   │   ├─→ 连接错误
   │   │   └─→ netconnpool.CloseConnection(conn)
   │   │       └─→ 从池中移除连接
   │   │
   │   ├─→ DNS错误
   │   │   └─→ domaindns.ClearCache()
   │   │       └─→ 切换DNS服务器重试
   │   │
   │   ├─→ IP封锁错误
   │   │   └─→ localippool.MarkBlocked(ip)
   │   │       └─→ 选择新IP重试
   │   │
   │   └─→ 指纹检测错误
   │       └─→ fingerprint.GetRandomFingerprint()
   │           └─→ 使用新指纹重试
   │
   └─→ 重试请求
```

## 库间数据流

### 1. 指纹数据流

```
fingerprint库
    │
    ├─→ FingerprintResult
    │   ├─→ Profile (TLS配置)
    │   │   └─→ conn库使用
    │   │       └─→ 配置TLS连接
    │   │
    │   ├─→ UserAgent
    │   │   └─→ HTTP请求头
    │   │
    │   └─→ Headers (完整HTTP头)
    │       └─→ HTTP请求使用
    │
    └─→ logs库记录指纹选择
```

### 2. DNS数据流

```
domaindns库
    │
    ├─→ Resolve(domain)
    │   ├─→ 查询DNS缓存
    │   │   └─→ 缓存命中 → 直接返回
    │   │
    │   └─→ 缓存未命中
    │       ├─→ 查询DNS服务器
    │       │   └─→ 更新缓存
    │       │
    │       └─→ 返回IP地址
    │           │
    │           └─→ conn库使用
    │               └─→ 建立连接
    │
    └─→ logs库记录DNS解析
```

### 3. IP数据流

```
localippool库
    │
    ├─→ GetAvailableIP()
    │   ├─→ 检查IP健康状态
    │   ├─→ 根据策略选择IP
    │   │   ├─→ 轮询策略
    │   │   ├─→ 随机策略
    │   │   └─→ 最少使用策略
    │   │
    │   └─→ 返回IP地址
    │       │
    │       └─→ conn库使用
    │           └─→ 绑定本地IP
    │
    ├─→ MarkHealthy(ip)
    │   └─→ 更新IP状态
    │
    ├─→ MarkBlocked(ip)
    │   └─→ 标记IP为被封锁
    │
    └─→ logs库记录IP使用
```

### 4. 连接数据流

```
conn库 (连接抽象)
    │
    ├─→ NewConnection(options)
    │   ├─→ 使用 fingerprint.Profile 配置TLS
    │   ├─→ 使用 domaindns 解析的IP作为目标
    │   ├─→ 使用 localippool 的IP作为本地IP
    │   │
    │   └─→ 创建连接对象
    │       │
    │       └─→ netconnpool/quic库管理
    │
    ├─→ SendRequest(req)
    │   ├─→ 使用 fingerprint.Headers
    │   ├─→ 发送HTTP请求
    │   └─→ logs库记录请求
    │
    └─→ Close()
        └─→ 释放连接资源
```

### 5. 日志数据流

```
logs库 (贯穿所有模块)
    │
    ├─→ fingerprint库
    │   └─→ 记录指纹选择、生成
    │
    ├─→ domaindns库
    │   └─→ 记录DNS解析、缓存命中
    │
    ├─→ localippool库
    │   └─→ 记录IP选择、状态更新
    │
    ├─→ conn库
    │   └─→ 记录连接创建、请求、响应
    │
    ├─→ netconnpool库
    │   └─→ 记录连接池操作、统计
    │
    └─→ quic库
        └─→ 记录QUIC连接操作
```

## 关键集成点

### 1. 指纹与连接的集成

```go
// fingerprint提供TLS配置
fp, _ := fingerprint.GetRandomFingerprint()

// conn使用指纹创建连接
conn, _ := conn.NewConnection(
    conn.WithTLSConfig(fp.Profile.GetClientHelloSpec()),
    conn.WithUserAgent(fp.UserAgent),
    conn.WithHeaders(fp.Headers.ToMap()),
)
```

### 2. DNS与连接的集成

```go
// domaindns解析域名
ip, _ := dnsResolver.Resolve(ctx, "example.com")

// conn使用解析的IP
conn, _ := conn.NewConnection(
    conn.WithTargetIP(ip),
)
```

### 3. IP池与连接的集成

```go
// localippool分配IP
localIP, _ := ipPool.GetAvailableIP()

// conn绑定本地IP
conn, _ := conn.NewConnection(
    conn.WithLocalIP(localIP),
)
```

### 4. 连接池的集成

```go
// netconnpool管理TCP连接
tcpPool := netconnpool.NewPool(
    netconnpool.WithDNSResolver(dnsResolver),
    netconnpool.WithIPPool(ipPool),
    netconnpool.WithFingerprintManager(fingerprintMgr),
)

// quic管理QUIC连接
quicPool := quic.NewPool(
    quic.WithDNSResolver(dnsResolver),
    quic.WithIPPool(ipPool),
    quic.WithFingerprintManager(fingerprintMgr),
)
```

## 配置依赖关系

### 初始化顺序

```
1. logs (最先初始化，其他模块需要)
   │
2. fingerprint (独立，可并行)
3. domaindns (独立，可并行)
4. localippool (独立，可并行)
   │
5. conn (依赖 fingerprint, domaindns, localippool)
   │
6. netconnpool (依赖 conn, fingerprint, domaindns, localippool)
7. quic (依赖 conn, fingerprint, domaindns, localippool)
```

### 配置传递

```
SystemConfig
    │
    ├─→ LogConfig → logs
    │
    ├─→ FingerprintConfig → fingerprint
    │
    ├─→ DNSConfig → domaindns
    │
    ├─→ IPPoolConfig → localippool
    │
    ├─→ TCPPoolConfig → netconnpool
    │   └─→ 传递: dnsResolver, ipPool, fingerprintMgr
    │
    └─→ QUICPoolConfig → quic
        └─→ 传递: dnsResolver, ipPool, fingerprintMgr
```

## 性能优化协作

### 1. 连接复用

```
netconnpool/quic
    │
    ├─→ 连接池缓存连接
    │   └─→ 减少连接建立开销
    │
    └─→ 连接健康检查
        └─→ 自动清理无效连接
```

### 2. DNS缓存

```
domaindns
    │
    ├─→ 缓存DNS解析结果
    │   └─→ 减少DNS查询次数
    │
    └─→ 定期刷新缓存
        └─→ 保持解析准确性
```

### 3. IP轮换

```
localippool
    │
    ├─→ 智能IP选择
    │   └─→ 避免IP过度使用
    │
    └─→ IP健康监控
        └─→ 自动标记异常IP
```

## 错误处理协作

### 错误传播链

```
conn错误
    │
    ├─→ netconnpool/quic
    │   └─→ 关闭连接，从池中移除
    │
    ├─→ logs
    │   └─→ 记录错误详情
    │
    └─→ 应用层
        └─→ 决定重试或切换策略

DNS错误
    │
    ├─→ domaindns
    │   └─→ 切换DNS服务器，清空缓存
    │
    ├─→ logs
    │   └─→ 记录DNS错误
    │
    └─→ 应用层
        └─→ 重试请求

IP封锁错误
    │
    ├─→ localippool
    │   └─→ 标记IP为被封锁，选择新IP
    │
    ├─→ logs
    │   └─→ 记录IP封锁
    │
    └─→ 应用层
        └─→ 使用新IP重试
```

## 监控和统计协作

```
各库提供统计信息
    │
    ├─→ fingerprint: 指纹使用统计
    ├─→ domaindns: DNS解析统计
    ├─→ localippool: IP使用统计
    ├─→ netconnpool: 连接池统计
    └─→ quic: QUIC连接池统计
        │
        └─→ logs记录统计信息
            │
            └─→ 应用层汇总统计
```

## 总结

7个库通过清晰的职责划分和依赖关系，形成了一个完整的反审查爬虫系统：

1. **fingerprint** - 提供指纹模拟能力
2. **domaindns** - 提供DNS解析能力
3. **localippool** - 提供IP管理能力
4. **conn** - 提供连接抽象能力
5. **netconnpool** - 提供TCP连接池能力
6. **quic** - 提供QUIC连接池能力
7. **logs** - 提供日志记录能力

各库通过接口和配置进行协作，实现了高度的模块化和可扩展性。

